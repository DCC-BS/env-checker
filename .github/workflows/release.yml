name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-extension:
    name: Build Zed Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2

      - name: Build extension
        working-directory: ./extension
        run: cargo build --target wasm32-wasip2

      - name: Rename WASM output
        run: mv extension/target/wasm32-wasip2/debug/deps/env_checker_zed.wasm extension/extension.wasm

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-wasm
          path: extension/extension.wasm
          retention-days: 1

  build-lsp:
    name: Build LSP
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            arch: x86_64
            platform: unknown-linux-gnu
            ext: tar.gz
          - os: macos-latest
            target: aarch64-apple-darwin
            arch: aarch64
            platform: apple-darwin
            ext: tar.gz
          - os: macos-13
            target: x86_64-apple-darwin
            arch: x86_64
            platform: apple-darwin
            ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x86_64
            platform: pc-windows-msvc
            ext: zip
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-zigbuild (for Linux cross-compilation)
        if: matrix.os == 'ubuntu-latest'
        uses: taiki-e/install-action@cargo-zigbuild

      - name: Install musl-tools (for Linux musl target)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get install -y musl-tools

      - name: Build LSP
        run: cargo build --release --target ${{ matrix.target }} --manifest-path=lsp/Cargo.toml

      - name: Prepare Linux artifacts
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p release-artifact
          cp lsp/target/${{ matrix.target }}/release/env-checker-lsp release-artifact/
          cd release-artifact
          tar czf env-checker-lsp-${{ github.ref_name }}-${{ matrix.arch }}-${{ matrix.platform }}.${{ matrix.ext }} env-checker-lsp

      - name: Prepare macOS artifacts
        if: matrix.os == 'macos-latest' || matrix.os == 'macos-13'
        run: |
          mkdir -p release-artifact
          cp lsp/target/${{ matrix.target }}/release/env-checker-lsp release-artifact/
          cd release-artifact
          tar czf env-checker-lsp-${{ github.ref_name }}-${{ matrix.arch }}-${{ matrix.platform }}.${{ matrix.ext }} env-checker-lsp

      - name: Prepare Windows artifacts
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path release-artifact
          Copy-Item lsp\target\${{ matrix.target }}\release\env-checker-lsp.exe release-artifact\
          cd release-artifact
          New-Item -ItemType Directory -Force -Path target\release
          Move-Item env-checker-lsp.exe target\release\
          Compress-Archive -Path target -DestinationPath env-checker-lsp-${{ github.ref_name }}-${{ matrix.arch }}-${{ matrix.platform }}.${{ matrix.ext }}

      - name: Upload LSP artifact
        uses: actions/upload-artifact@v4
        with:
          name: lsp-${{ matrix.os }}-${{ matrix.arch }}
          path: release-artifact/env-checker-lsp-${{ github.ref_name }}-${{ matrix.arch }}-${{ matrix.platform }}.${{ matrix.ext }}
          retention-days: 1

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-extension, build-lsp]
    permissions:
      contents: write
    steps:
      - name: Download extension artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-wasm
          path: ./artifacts

      - name: Download LSP artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: lsp-*
          path: ./artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/extension.wasm
            artifacts/*.tar.gz
            artifacts/*.zip
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}